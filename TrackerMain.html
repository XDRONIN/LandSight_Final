<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Satellite Tracking</title>
    <script src="https://unpkg.com/satellite.js@4.0.0/dist/satellite.min.js"></script>
  </head>
  <body>
    <h1>Next Closest Satellite Approach</h1>
    <div id="satellite-approach-details">
      <p>Loading data...</p>
    </div>

    <script>
      let TheDate;
      const urlParams = new URLSearchParams(window.location.search);
      const Loclatitude = urlParams.get("latitude");
      const Loclongitude = urlParams.get("longitude");
      let apiData1 = null;
      let apiData2 = null;

      // Create an async function to fetch data
      async function fetchData() {
        document.getElementById(
          "satellite-approach-details"
        ).innerHTML = `<p>Loading data...</p>`;
        try {
          const response = await fetch(
            "https://tle.ivanstanojevic.me/api/tle/49260"
          );

          if (!response.ok) {
            throw new Error("Network response was not ok");
          }

          const data = await response.json();

          // Assign fetched data to the global variable
          apiData1 = data.line1;
          apiData2 = data.line2;
        } catch (error) {
          console.error("There was a problem with the fetch operation:", error);
          document.getElementById(
            "satellite-approach-details"
          ).innerHTML = `<p>Error fetching data: ${error.message}</p>`;
        }
      }

      function formatDate(date) {
        // Format date as YYYY-MM-DD HH:MM:SS
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, "0"); // Months are zero-based
        const day = String(date.getUTCDate()).padStart(2, "0");
        const hours = String(date.getUTCHours()).padStart(2, "0");
        const minutes = String(date.getUTCMinutes()).padStart(2, "0");
        const seconds = String(date.getUTCSeconds()).padStart(2, "0");

        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      }

      async function mainProgram() {
        await fetchData();

        // Ensure that apiData1 and apiData2 are fetched before proceeding
        if (!apiData1 || !apiData2) {
          console.error("TLE data is not available.");
          document.getElementById(
            "satellite-approach-details"
          ).innerHTML = `<p>Error: TLE data not available.</p>`;
          return;
        }

        function parseTLE(tle) {
          const lines = tle.split("\n");
          return satellite.twoline2satrec(lines[1].trim(), lines[2].trim());
        }

        function calculateDistance(satPosition, targetCoords) {
          const targetPosition = satellite.geodeticToEcf({
            latitude: targetCoords.latitude,
            longitude: targetCoords.longitude,
            height: 0, // target is at sea level
          });
          const dx = satPosition.x - targetPosition.x;
          const dy = satPosition.y - targetPosition.y;
          const dz = satPosition.z - targetPosition.z;

          return Math.sqrt(dx * dx + dy * dy + dz * dz);
        }

        function findNextClosestApproach(
          satrec,
          targetCoords,
          timeStep,
          maxSteps
        ) {
          let minimumDistance = Number.MAX_VALUE;
          let closestPosition = null;
          let closestTime = null;

          let currentTime = new Date();
          for (let i = 0; i < maxSteps; i++) {
            const time = new Date(currentTime.getTime() + i * timeStep);
            const positionAndVelocity = satellite.propagate(satrec, time);
            const gmst = satellite.gstime(time);
            const satPositionEcf = satellite.eciToEcf(
              positionAndVelocity.position,
              gmst
            );

            const distance = calculateDistance(satPositionEcf, targetCoords);

            if (distance < minimumDistance) {
              minimumDistance = distance;
              closestPosition = satellite.eciToGeodetic(
                positionAndVelocity.position,
                gmst
              );
              closestTime = time;
              TheDate = time; // Update TheDate with the closest time
            }
          }

          return {
            position: closestPosition,
            distance: minimumDistance,
            time: closestTime,
          };
        }

        function main(tleData, targetCoords, timeStep, maxSteps) {
          const satrec = parseTLE(tleData);

          const result = findNextClosestApproach(
            satrec,
            targetCoords,
            timeStep,
            maxSteps
          );

          const detailsDiv = document.getElementById(
            "satellite-approach-details"
          );
          detailsDiv.innerHTML = `
                <p>Next closest approach:</p>
                <p>Time: ${formatDate(result.time)}</p>
                <p>Position: Lat ${
                  (result.position.latitude * 180) / Math.PI
                }°, Lon ${
            (result.position.longitude * 180) / Math.PI
          }°, Alt ${result.position.height.toFixed(2)} km</p>
                <p>Distance: ${result.distance.toFixed(2)} km</p>
            `;
        }

        const tle = `LANDSAT 9
${apiData1}
${apiData2}`;

        const targetCoords = {
          latitude: (Loclatitude * Math.PI) / 180,
          longitude: (Loclongitude * Math.PI) / 180,
        };

        const timeStep = 60 * 1000; // 1 minute in milliseconds
        const maxSteps = 23040; // 16 days of steps (1440 minutes in a day)

        main(tle, targetCoords, timeStep, maxSteps);
        // Log formatted TheDate after it has been assigned
        console.log(`The closest time is ${formatDate(TheDate)}`);
      }

      mainProgram();

      // Button functionality
      document.querySelector(".getNot").addEventListener("click", () => {
        alert("Notification feature coming soon!");
      });
    </script>

    <button class="getNot" id="getNot">Get Notified Before Approach</button>
    <script>
      const butt = document.getElementById("getNot");
      butt.addEventListener("click", () => {
        window.location.href = `sms.html?date=${encodeURIComponent(TheDate)}`;
      });
    </script>
  </body>
</html>
